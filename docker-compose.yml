version: '3.8'

services:
  cms:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cyberjab-cms
    restart: unless-stopped
    ports:
      - "3000:3000"
      - "4001:4001"  # TinaCMS GraphQL API
    environment:
      # TinaCMS Configuration
      - TINA_PUBLIC_IS_LOCAL=false
      - TINA_BRANCH=${TINA_BRANCH:-main}
      - TINA_CLIENT_ID=${TINA_CLIENT_ID}
      - TINA_TOKEN=${TINA_TOKEN}

      # Git Configuration
      - GIT_USER=${GIT_USER}
      - GIT_EMAIL=${GIT_EMAIL}
      - GH_TOKEN=${GH_TOKEN}
      - GIT_REMOTE=${GIT_REMOTE:-origin}
      - GIT_BRANCH=${GIT_BRANCH:-main}

      # GitHub Repository
      - GITHUB_OWNER=${GITHUB_OWNER}
      - GITHUB_REPO=${GITHUB_REPO}

      # Node Environment
      - NODE_ENV=production
    volumes:
      # Persist content directory
      - ./content:/app/content

      # Persist Git directory (important for commits)
      - ./.git:/app/.git

      # Optional: Persist uploads
      - ./public/uploads:/app/public/uploads
    networks:
      - cms-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  cms-network:
    driver: bridge

volumes:
  content-data:
  git-data:
